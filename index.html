<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sushi Platter Builder</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  :root {
    --bg: #f5f5f7;
    --card-bg: #ffffff;
    --text: #222;
    --muted: #666;
    --accent: #ff7043;
    --accent-alt: #1976d2;
    --danger: #c62828;
    --shadow: 0 2px 10px rgba(0,0,0,0.08);
  }
  body.dark {
    --bg: #101018;
    --card-bg: #1d1f27;
    --text: #f5f5f5;
    --muted: #9fa3b5;
    --accent: #ffa726;
    --accent-alt: #64b5f6;
    --danger: #ef5350;
    --shadow: 0 2px 18px rgba(0,0,0,0.7);
  }

  * { box-sizing: border-box; }

  body {
    margin: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: var(--bg);
    color: var(--text);
  }

  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 14px;
    background: #000;
    color: #fff;
  }

  header h1 {
    font-size: 18px;
    margin: 0;
  }

  .header-right {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .btn {
    border: none;
    border-radius: 999px;
    padding: 7px 14px;
    font-size: 13px;
    cursor: pointer;
    background: var(--accent);
    color: #fff;
    white-space: nowrap;
  }

  .btn-secondary {
    background: #444;
  }

  .btn-outline {
    background: transparent;
    border: 1px solid #666;
    color: #fff;
  }

  .main {
    display: flex;
    gap: 12px;
    padding: 10px;
  }

  @media (max-width: 900px) {
    .main {
      flex-direction: column;
    }
  }

  .panel {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 12px;
    box-shadow: var(--shadow);
  }

  .left-panel {
    flex: 1.7;
    min-width: 0;
  }

  .right-panel {
    flex: 1;
    max-width: 380px;
  }

  h2, h3, h4 {
    margin-top: 0;
  }

  input[type="text"],
  input[type="number"],
  select {
    width: 100%;
    padding: 7px 9px;
    margin: 4px 0 10px 0;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 14px;
    background: transparent;
    color: var(--text);
  }

  body.dark input,
  body.dark select {
    border-color: #555;
  }

  .filters {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .chip {
    padding: 4px 10px;
    border-radius: 999px;
    border: 1px solid #ccc;
    font-size: 12px;
    cursor: pointer;
    background: #f4f4f4;
    color: #333;
  }
  body.dark .chip {
    background: #333;
    color: #eee;
    border-color: #555;
  }
  .chip.active {
    background: var(--accent-alt);
    color: #fff;
    border-color: var(--accent-alt);
  }

  .menu-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
    gap: 10px;
  }

  .card {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 10px;
    box-shadow: var(--shadow);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }

  .card img {
    width: 100%;
    height: 140px;
    object-fit: cover;
    border-radius: 10px;
  }

  .card-title {
    font-size: 15px;
    font-weight: 600;
    margin-top: 8px;
  }

  .meta {
    font-size: 12px;
    color: var(--muted);
    margin-bottom: 3px;
  }

  .qty-row {
    display: flex;
    gap: 6px;
    align-items: center;
    margin-top: 6px;
  }

  .qty-row input {
    width: 60px;
    text-align: center;
  }

  .edit-box {
    margin-top: 14px;
    padding: 8px;
    border-radius: 10px;
    background: rgba(0,0,0,0.03);
    font-size: 12px;
  }
  body.dark .edit-box {
    background: rgba(255,255,255,0.05);
  }

  .edit-box h4 {
    margin: 0 0 6px 0;
    font-size: 13px;
  }

  .cart-item {
    padding: 8px 0;
    border-bottom: 1px solid #ddd;
  }
  body.dark .cart-item {
    border-color: #444;
  }

  .cart-row-top {
    display: flex;
    justify-content: space-between;
    font-size: 14px;
  }

  .cart-row-bottom {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: var(--muted);
    margin-top: 2px;
    align-items: center;
  }

  .qty-btn {
    background: var(--accent-alt);
    border: none;
    border-radius: 4px;
    width: 26px;
    height: 26px;
    color: #fff;
    font-size: 16px;
    cursor: pointer;
  }

  .remove-btn {
    background: var(--danger);
    border: none;
    border-radius: 4px;
    padding: 3px 7px;
    font-size: 11px;
    color: #fff;
    cursor: pointer;
    margin-left: 6px;
  }

  .summary {
    font-size: 13px;
    margin-top: 10px;
    border-top: 1px solid #ddd;
    padding-top: 8px;
  }
  body.dark .summary {
    border-color: #444;
  }

  .summary-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 2px;
  }
</style>
</head>
<body>
<script>
const SHEET_URL =
  "https://opensheet.elk.sh/1zf6BTACk1tLWS9diRqQ3m93aQawfHftiELjByrWjBgE/Sheet1";

let menuItems = [];
let cart = {};

let filters = {
  all: true,
  roll: false,
  nigiri: false,
  veg: false,
  spicy: false,
  raw: false,
  cooked: false
};

// ---------- LOAD SHEET ----------
fetch(SHEET_URL)
  .then(r => r.json())
  .then(data => {
    menuItems = data
      .map(row => {
        const image = (row["Sushi Plating"] || "").trim();
        const name  = (row["Name"] || "").trim();

        // FIXED PRICE PARSER ($9.49 ‚Üí 9.49)
        const price = parseFloat(
          (row["Price"] || "").toString().replace(/[$,]/g, "")
        ) || 0;

        const filling = row["Filling"] || "";
        const sauces  = row["Sauces"] || "";
        const toppings = row["Toppings"] || "";
        const saucesToppings = [sauces, toppings].filter(v => v).join(", ");

        if (!name) return null;
        const tags = deriveTags(name, filling, saucesToppings);

        return { image, name, price, filling, saucesToppings, tags };
      })
      .filter(Boolean);

    initEditSelect();
    renderMenu();
  })
  .catch(() => {
    document.getElementById("menuGrid").innerHTML =
      "<p>Error loading sheet. Check if published.</p>";
  });

// ---------- TAGGING ----------
function deriveTags(name, fill, s) {
  const t = (name + " " + fill + " " + s).toLowerCase();
  const tags = { roll:false, nigiri:false, veg:false, spicy:false, raw:false, cooked:false };

  if (t.includes("roll")) tags.roll = true;
  if (t.includes("nigiri")) tags.nigiri = true;

  const veg = ["cucumber","avocado","veg","vegetable","tofu","lettuce","asparagus"];
  const nonveg = ["salmon","tuna","eel","shrimp","crab","fish"];

  if (veg.some(w => t.includes(w)) && !nonveg.some(w => t.includes(w))) tags.veg = true;
  if (["spicy","jalapeno","chili"].some(w => t.includes(w))) tags.spicy = true;
  if (["raw","sashimi"].some(w => t.includes(w))) tags.raw = true;
  if (["tempura","fried","baked","grilled","eel","shrimp"].some(w => t.includes(w))) tags.cooked = true;

  return tags;
}

// ---------- FILTERS ----------
function toggleFilter(key) {
  if (key === "all") {
    filters = { all:true, roll:false, nigiri:false, veg:false, spicy:false, raw:false, cooked:false };
  } else {
    filters.all = false;
    filters[key] = !filters[key];
    if (!Object.values(filters).some((v, i) => i !== 0 && v)) filters.all = true;
  }
  updateFilterChips();
  renderMenu();
}

function updateFilterChips() {
  document.querySelectorAll(".chip").forEach(chip => {
    const f = chip.getAttribute("data-filter");
    chip.classList.toggle("active", filters[f]);
  });
}

function passesFilters(it) {
  if (filters.all) return true;
  for (let f in filters) {
    if (filters[f] && !it.tags[f]) return false;
  }
  return true;
}

// ---------- MENU ----------
function renderMenu() {
  const grid = document.getElementById("menuGrid");
  const search = (document.getElementById("searchInput").value || "").toLowerCase();

  grid.innerHTML = "";

  menuItems
    .filter(it => passesFilters(it))
    .filter(it => {
      const s = (it.name + it.filling + it.saucesToppings).toLowerCase();
      return s.includes(search);
    })
    .forEach(it => {
      const icons = [
        it.tags.veg ? "ü•ó" : "",
        it.tags.spicy ? "üå∂Ô∏è" : "",
        it.tags.raw ? "üêü" : "",
        it.tags.cooked ? "üç§" : ""
      ].filter(Boolean).join(" ");

      grid.innerHTML += `
        <div class="card">
          <img src="${it.image}" onerror="this.src='https://via.placeholder.com/400x280?text=Sushi';">
          <div class="card-title">${it.name} ‚Äî $${it.price.toFixed(2)}</div>
          <div class="meta">${icons}</div>
          <div class="meta"><b>Filling:</b> ${it.filling || "-"}</div>
          <div class="meta"><b>Sauces + Toppings:</b> ${it.saucesToppings || "-"}</div>
          <div class="qty-row">
            <input type="number" id="qty-${slug(it.name)}" value="1" min="1">
            <button class="btn" onclick="addToCartFromMenu('${encodeURIComponent(it.name)}')">Add</button>
          </div>
        </div>
      `;
    });
}

function slug(name) {
  return name.replace(/\s+/g, "_");
}

// ---------- CART ----------
function addToCartFromMenu(encoded) {
  const name = decodeURIComponent(encoded);
  const item = menuItems.find(i => i.name === name);
  if (!item) return;

  const qty = parseInt(document.getElementById("qty-" + slug(name)).value || "1");

  if (!cart[name]) cart[name] = { item, qty:0 };
  cart[name].qty += qty;

  renderCart();
}

function changeQty(name, delta) {
  cart[name].qty += delta;
  if (cart[name].qty <= 0) delete cart[name];
  renderCart();
}

function removeFromCart(name) {
  delete cart[name];
  renderCart();
}

function pieces(item) {
  return item.name.toLowerCase().includes("nigiri") ? 1 : 10;
}

function renderCart() {
  const div = document.getElementById("cartContainer");
  const sum = document.getElementById("summaryBox");

  div.innerHTML = "";
  let subtotal = 0;
  let totalPieces = 0;

  Object.keys(cart).forEach(name => {
    const { item, qty } = cart[name];
    subtotal += item.price * qty;
    totalPieces += pieces(item) * qty;

    div.innerHTML += `
      <div class="cart-item">
        <div class="cart-row-top">
          <span><b>${name}</b></span>
          <span>$${(item.price * qty).toFixed(2)}</span>
        </div>
        <div class="cart-row-bottom">
          <span>
            <button class="qty-btn" onclick="changeQty('${name}', -1)">-</button>
            ${qty}
            <button class="qty-btn" onclick="changeQty('${name}', 1)">+</button>
            <button class="remove-btn" onclick="removeFromCart('${name}')">x</button>
          </span>
          <span>${pieces(item) * qty} pcs</span>
        </div>
      </div>
    `;
  });

  if (!Object.keys(cart).length) {
    div.innerHTML = "<p class='meta'>Cart is empty.</p>";
  }

  const taxRate = parseFloat(document.getElementById("taxInput").value || 0) / 100;
  const tax = subtotal * taxRate;
  const total = subtotal + tax;

  sum.innerHTML = `
    <div class="summary-row"><b>Subtotal:</b> <span>$${subtotal.toFixed(2)}</span></div>
    <div class="summary-row"><b>Tax:</b> <span>$${tax.toFixed(2)}</span></div>
    <div class="summary-row"><b>Total:</b> <span>$${total.toFixed(2)}</span></div>
    <br>
    <div class="summary-row"><b>Total Pieces:</b> <span>${totalPieces}</span></div>
  `;
}

function clearCart() {
  cart = {};
  renderCart();
}

// ---------- PRICE EDIT ----------
function initEditSelect() {
  const s = document.getElementById("editItemSelect");
  s.innerHTML = "";
  menuItems.forEach(it => {
    const opt = document.createElement("option");
    opt.value = it.name;
    opt.textContent = `${it.name} ($${it.price.toFixed(2)})`;
    s.appendChild(opt);
  });
}

function updateItemPrice() {
  const sel = document.getElementById("editItemSelect").value;
  const newPrice = parseFloat(document.getElementById("editPriceInput").value || "NaN");
  if (isNaN(newPrice)) {
    alert("Invalid price");
    return;
  }
  const item = menuItems.find(i => i.name === sel);
  item.price = newPrice;
  if (cart[sel]) cart[sel].item.price = newPrice;
  initEditSelect();
  renderMenu();
  renderCart();
}

// ---------- DARK MODE ----------
function toggleDarkMode() {
  document.body.classList.toggle("dark");
}
</script>

</body>
</html>
