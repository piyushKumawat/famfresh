<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sushi Platter Builder</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  :root {
    --bg: #f5f5f7;
    --card-bg: #ffffff;
    --text: #222;
    --muted: #666;
    --accent: #ff7043;
    --accent-alt: #1976d2;
    --danger: #c62828;
    --shadow: 0 2px 10px rgba(0,0,0,0.08);
  }
  body.dark {
    --bg: #101018;
    --card-bg: #1d1f27;
    --text: #f5f5f5;
    --muted: #9fa3b5;
    --accent: #ffa726;
    --accent-alt: #64b5f6;
    --danger: #ef5350;
    --shadow: 0 2px 18px rgba(0,0,0,0.7);
  }

  * { box-sizing: border-box; }

  body {
    margin: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: var(--bg);
    color: var(--text);
  }

  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 14px;
    background: #000;
    color: #fff;
  }

  header h1 {
    font-size: 18px;
    margin: 0;
  }

  .header-right {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .btn {
    border: none;
    border-radius: 999px;
    padding: 7px 14px;
    font-size: 13px;
    cursor: pointer;
    background: var(--accent);
    color: #fff;
    white-space: nowrap;
  }

  .btn-secondary {
    background: #444;
  }

  .btn-outline {
    background: transparent;
    border: 1px solid #666;
    color: #fff;
  }

  .main {
    display: flex;
    gap: 12px;
    padding: 10px;
  }

  @media (max-width: 900px) {
    .main {
      flex-direction: column;
    }
  }

  .panel {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 12px;
    box-shadow: var(--shadow);
  }

  .left-panel {
    flex: 1.7;
    min-width: 0;
  }

  .right-panel {
    flex: 1;
    max-width: 380px;
  }

  h2, h3, h4 {
    margin-top: 0;
  }

  input[type="text"],
  input[type="number"],
  select {
    width: 100%;
    padding: 7px 9px;
    margin: 4px 0 10px 0;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 14px;
    background: transparent;
    color: var(--text);
  }

  body.dark input,
  body.dark select {
    border-color: #555;
  }

  .filters {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 10px;
  }

  .chip {
    padding: 4px 10px;
    border-radius: 999px;
    border: 1px solid #ccc;
    font-size: 12px;
    cursor: pointer;
    background: #f4f4f4;
    color: #333;
  }
  body.dark .chip {
    background: #333;
    color: #eee;
    border-color: #555;
  }
  .chip.active {
    background: var(--accent-alt);
    color: #fff;
    border-color: var(--accent-alt);
  }

  .menu-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
    gap: 10px;
  }

  .card {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 10px;
    box-shadow: var(--shadow);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }

  .card img {
    width: 100%;
    height: 140px;
    object-fit: cover;
    border-radius: 10px;
    margin-bottom: 8px;
    background: #ddd;
  }

  .card-title {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 4px;
  }

  .meta {
    font-size: 12px;
    color: var(--muted);
    margin-bottom: 3px;
  }

  .tags {
    font-size: 12px;
    margin-bottom: 4px;
  }

  .qty-row {
    display: flex;
    gap: 6px;
    align-items: center;
    margin-top: 6px;
  }

  .qty-row input {
    width: 60px;
    text-align: center;
  }

  .edit-box {
    margin-top: 14px;
    padding: 8px;
    border-radius: 10px;
    background: rgba(0,0,0,0.03);
    font-size: 12px;
  }
  body.dark .edit-box {
    background: rgba(255,255,255,0.05);
  }

  .edit-box h4 {
    margin: 0 0 6px 0;
    font-size: 13px;
  }

  .preset-row {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin: 6px 0 10px 0;
  }

  .preset-btn {
    border: none;
    border-radius: 999px;
    padding: 5px 10px;
    font-size: 11px;
    cursor: pointer;
    background: #eee;
    color: #333;
  }
  body.dark .preset-btn {
    background: #333;
    color: #eee;
  }
  .preset-btn:hover {
    background: var(--accent-alt);
    color: #fff;
  }

  .cart-item {
    padding: 8px 0;
    border-bottom: 1px solid #ddd;
  }
  body.dark .cart-item {
    border-color: #444;
  }

  .cart-row-top {
    display: flex;
    justify-content: space-between;
    font-size: 14px;
  }

  .cart-row-bottom {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: var(--muted);
    margin-top: 2px;
    align-items: center;
  }

  .qty-btn {
    background: var(--accent-alt);
    border: none;
    border-radius: 4px;
    width: 26px;
    height: 26px;
    color: #fff;
    font-size: 16px;
    cursor: pointer;
  }

  .remove-btn {
    background: var(--danger);
    border: none;
    border-radius: 4px;
    padding: 3px 7px;
    font-size: 11px;
    color: #fff;
    cursor: pointer;
    margin-left: 6px;
  }

  .summary {
    font-size: 13px;
    margin-top: 10px;
    border-top: 1px solid #ddd;
    padding-top: 8px;
  }
  body.dark .summary {
    border-color: #444;
  }

  .summary-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 2px;
  }

  .summary-row b {
    font-weight: 600;
  }

  .hint {
    font-size: 11px;
    color: var(--muted);
  }
</style>
</head>
<body>

<header>
  <h1>üç£ Sushi Platter Builder</h1>
  <div class="header-right">
    <button class="btn btn-outline" onclick="toggleDarkMode()">üåô</button>
    <button class="btn btn-secondary" onclick="window.print()">Print / Save PDF</button>
  </div>
</header>

<div class="main">
  <!-- LEFT: MENU -->
  <div class="panel left-panel">
    <h2>Menu</h2>

    <input
      type="text"
      id="searchInput"
      placeholder="Search by name, filling, sauce..."
      oninput="renderMenu()"
    />

    <div class="filters">
      <span class="chip active" data-filter="all" onclick="toggleFilter('all')">All</span>
      <span class="chip" data-filter="roll" onclick="toggleFilter('roll')">Rolls</span>
      <span class="chip" data-filter="nigiri" onclick="toggleFilter('nigiri')">Nigiri</span>
      <span class="chip" data-filter="veg" onclick="toggleFilter('veg')">Veg</span>
      <span class="chip" data-filter="spicy" onclick="toggleFilter('spicy')">Spicy</span>
      <span class="chip" data-filter="raw" onclick="toggleFilter('raw')">Raw</span>
      <span class="chip" data-filter="cooked" onclick="toggleFilter('cooked')">Cooked</span>
    </div>

    <div class="preset-row">
      <button class="preset-btn" onclick="buildPlatter('veg')">Veggie Platter</button>
      <button class="preset-btn" onclick="buildPlatter('mixed')">Mixed Platter</button>
      <button class="preset-btn" onclick="buildPlatter('nigiri')">Nigiri Platter</button>
    </div>
    <div class="hint">Platters auto-add items to cart ‚Äî adjust quantities there.</div>

    <h3 style="margin-top:10px;">Sushi from Google Sheet</h3>
    <div id="menuGrid" class="menu-grid"></div>

    <div class="edit-box">
      <h4>Quick Price Edit (local only)</h4>
      <select id="editItemSelect"></select>
      <input type="number" id="editPriceInput" placeholder="New price" step="0.1" />
      <button class="btn btn-secondary" style="width:100%; margin-top:4px;" onclick="updateItemPrice()">
        Update Price
      </button>
      <div class="hint">This changes prices only on this site, not in Google Sheets.</div>
    </div>
  </div>

  <!-- RIGHT: CART -->
  <div class="panel right-panel">
    <h2>Cart</h2>
    <div id="cartContainer"></div>

    <div class="summary" id="summaryBox"></div>

    <h3 style="margin-top:12px;">Settings</h3>
    <label>Tax %</label>
    <input type="number" id="taxInput" value="8" step="0.1" oninput="renderCart()" />
    <label>Store cut %</label>
    <input type="number" id="storeCutInput" value="25" step="0.5" oninput="renderCart()" />
    <label>Owner cut %</label>
    <input type="number" id="ownerCutInput" value="32" step="0.5" oninput="renderCart()" />

    <button class="btn btn-secondary" style="width:100%; margin-top:10px;" onclick="clearCart()">
      Clear Cart
    </button>
  </div>
</div>

<script>
  // ---- CONFIG ----
  const SHEET_URL =
    "https://opensheet.elk.sh/1zf6BTACk1tLWS9diRqQ3m93aQawfHftiELjByrWjBgE/Sheet1";

  let menuItems = []; // { image,name,price,filling,sauces,toppings,tags }
  let cart = {};      // name -> { item, qty }

  // filters
  let filters = {
    all: true,
    roll: false,
    nigiri: false,
    veg: false,
    spicy: false,
    raw: false,
    cooked: false
  };

  // ---- LOAD SHEET ----
  fetch(SHEET_URL)
    .then(res => res.json())
    .then(data => {
      menuItems = data
        .map(row => {
          const image = (row["Sushi Plating"] || "").trim(); // image URL
          const name = (row["Name"] || "").trim();
          const price = parseFloat(row["Price"] || "0") || 0;
          const filling = row["Filling"] || "";
          const sauces = row["Sauces"] || "";
          const toppings = row["Toppings"] || "";

          const saucesToppings = [sauces, toppings]
            .filter(v => v && v.trim() !== "")
            .join(", ");

          if (!name) return null;

          const tags = deriveTags(name, filling, saucesToppings);

          return {
            image,
            name,
            price,
            filling,
            saucesToppings,
            tags
          };
        })
        .filter(Boolean);

      initEditSelect();
      renderMenu();
    })
    .catch(err => {
      console.error("Error loading sheet:", err);
      document.getElementById("menuGrid").innerHTML =
        "<p>Could not load menu. Check that the sheet is published and headers are correct.</p>";
    });

  // ---- TAGGING (Roll/Nigiri/Veg/Spicy/Raw/Cooked) ----
  function deriveTags(name, filling, saucesToppings) {
    const text = (name + " " + filling + " " + saucesToppings).toLowerCase();
    const tags = {
      roll: false,
      nigiri: false,
      veg: false,
      spicy: false,
      raw: false,
      cooked: false
    };

    if (text.includes("roll")) tags.roll = true;
    if (text.includes("nigiri")) tags.nigiri = true;

    const vegWords = ["cucumber", "avocado", "veg", "veggie", "vegetable", "tofu", "carrot", "lettuce", "asparagus"];
    const nonVegWords = ["salmon", "tuna", "eel", "shrimp", "crab", "chicken", "beef", "fish", "yellowtail"];

    const spicyWords = ["spicy", "chili", "chilli", "jalapeno", "sriracha", "hot"];
    const rawWords = ["sashimi", "raw"];
    const cookedWords = ["tempura", "fried", "baked", "grilled", "seared"];

    if (vegWords.some(w => text.includes(w)) && !nonVegWords.some(w => text.includes(w))) {
      tags.veg = true;
    }

    if (spicyWords.some(w => text.includes(w))) tags.spicy = true;

    if (rawWords.some(w => text.includes(w))) tags.raw = true;
    if (nonVegWords.some(w => text.includes(w)) && !cookedWords.some(w => text.includes(w))) {
      tags.raw = true;
    }

    if (cookedWords.some(w => text.includes(w))) tags.cooked = true;
    if (text.includes("eel") || text.includes("shrimp")) tags.cooked = true;

    return tags;
  }

  // ---- FILTERS & SEARCH ----
  function toggleFilter(key) {
    if (key === "all") {
      filters = {
        all: true,
        roll: false,
        nigiri: false,
        veg: false,
        spicy: false,
        raw: false,
        cooked: false
      };
    } else {
      filters.all = false;
      filters[key] = !filters[key];
      if (!Object.keys(filters).some(k => k !== "all" && filters[k])) {
        filters.all = true;
      }
    }
    updateFilterChips();
    renderMenu();
  }

  function updateFilterChips() {
    document.querySelectorAll(".chip").forEach(chip => {
      const f = chip.getAttribute("data-filter");
      chip.classList.toggle("active", !!filters[f]);
    });
  }

  function passesFilters(item) {
    if (filters.all) return true;

    if (filters.roll && !item.tags.roll) return false;
    if (filters.nigiri && !item.tags.nigiri) return false;
    if (filters.veg && !item.tags.veg) return false;
    if (filters.spicy && !item.tags.spicy) return false;
    if (filters.raw && !item.tags.raw) return false;
    if (filters.cooked && !item.tags.cooked) return false;

    return true;
  }

  // ---- RENDER MENU ----
  function renderMenu() {
    const grid = document.getElementById("menuGrid");
    const search = (document.getElementById("searchInput").value || "").toLowerCase();
    grid.innerHTML = "";

    menuItems
      .filter(it => passesFilters(it))
      .filter(it => {
        if (!search) return true;
        const s = (it.name + " " + it.filling + " " + it.saucesToppings).toLowerCase();
        return s.includes(search);
      })
      .forEach(it => {
        const icons = [
          it.tags.veg ? "ü•ó" : "",
          it.tags.spicy ? "üå∂Ô∏è" : "",
          it.tags.raw ? "üêü" : "",
          it.tags.cooked ? "üç§" : ""
        ]
          .filter(Boolean)
          .join(" ");

        const saucesLine = it.saucesToppings || "‚Äî";
        const filling = it.filling || "‚Äî";

        const imgSrc = it.image || "https://via.placeholder.com/400x280?text=Sushi";

        grid.innerHTML += `
          <div class="card">
            <img src="${imgSrc}" alt="${it.name}" onerror="this.src='https://via.placeholder.com/400x280?text=Sushi';" />
            <div class="card-title">${it.name} ‚Äî $${it.price.toFixed(2)}</div>
            <div class="tags">${icons}</div>
            <div class="meta"><b>Filling:</b> ${filling}</div>
            <div class="meta"><b>Sauces + Toppings:</b> ${saucesLine}</div>
            <div class="qty-row">
              <input type="number" min="1" value="1" id="qty-${slug(it.name)}" />
              <button class="btn" style="padding:6px 10px;" onclick="addToCartFromMenu('${encodeURIComponent(it.name)}')">
                Add
              </button>
            </div>
          </div>
        `;
      });

    if (!grid.innerHTML) {
      grid.innerHTML = "<p>No items match the current search/filters.</p>";
    }
  }

  function slug(name) {
    return name.replace(/\s+/g, "_").replace(/[^a-zA-Z0-9_]/g, "");
  }

  // ---- CART ----
  function addToCartFromMenu(encodedName) {
    const name = decodeURIComponent(encodedName);
    const item = menuItems.find(i => i.name === name);
    if (!item) return;

    const qtyInput = document.getElementById("qty-" + slug(name));
    let qty = parseInt(qtyInput?.value || "1");
    if (isNaN(qty) || qty < 1) qty = 1;

    if (!cart[name]) {
      cart[name] = { item, qty };
    } else {
      cart[name].qty += qty;
    }
    renderCart();
  }

  function changeQty(name, delta) {
    if (!cart[name]) return;
    cart[name].qty += delta;
    if (cart[name].qty <= 0) delete cart[name];
    renderCart();
  }

  function removeFromCart(name) {
    delete cart[name];
    renderCart();
  }

  function guessPieces(item) {
    const n = item.name.toLowerCase();
    if (n.includes("nigiri")) return 1;
    return 10; // default rolls = 10 pcs
  }

  function renderCart() {
    const cartDiv = document.getElementById("cartContainer");
    const summaryDiv = document.getElementById("summaryBox");

    cartDiv.innerHTML = "";

    let subtotal = 0;
    let totalPieces = 0;

    Object.keys(cart).forEach(name => {
      const { item, qty } = cart[name];
      const lineTotal = item.price * qty;
      const pieces = guessPieces(item) * qty;

      subtotal += lineTotal;
      totalPieces += pieces;

      cartDiv.innerHTML += `
        <div class="cart-item">
          <div class="cart-row-top">
            <span><b>${name}</b></span>
            <span>$${lineTotal.toFixed(2)}</span>
          </div>
          <div class="cart-row-bottom">
            <span>
              <button class="qty-btn" onclick="changeQty('${name.replace(/'/g,"\\'")}', -1)">-</button>
              ${qty}
              <button class="qty-btn" onclick="changeQty('${name.replace(/'/g,"\\'")}', 1)">+</button>
              <button class="remove-btn" onclick="removeFromCart('${name.replace(/'/g,"\\'")}')">x</button>
            </span>
            <span>${pieces} pcs</span>
          </div>
        </div>
      `;
    });

    if (!Object.keys(cart).length) {
      cartDiv.innerHTML = "<p class='hint'>Cart is empty. Add items from the menu.</p>";
    }

    const taxRate = parseFloat(document.getElementById("taxInput").value || "0") / 100;
    const storeRate = parseFloat(document.getElementById("storeCutInput").value || "0") / 100;
    const ownerRate = parseFloat(document.getElementById("ownerCutInput").value || "0") / 100;

    const tax = subtotal * taxRate;
    const total = subtotal + tax;
    const storeShare = total * storeRate;
    const ownerShare = total * ownerRate;
    const yourProfit = total - storeShare - ownerShare;

    summaryDiv.innerHTML = `
      <div class="summary-row"><b>Subtotal:</b> <span>$${subtotal.toFixed(2)}</span></div>
      <div class="summary-row"><b>Tax:</b> <span>$${tax.toFixed(2)}</span></div>
      <div class="summary-row"><b>Total:</b> <span>$${total.toFixed(2)}</span></div>
      <br>
      <div class="summary-row"><b>Store (${(storeRate*100).toFixed(1)}%):</b> <span>$${storeShare.toFixed(2)}</span></div>
      <div class="summary-row"><b>Owner (${(ownerRate*100).toFixed(1)}%):</b> <span>$${ownerShare.toFixed(2)}</span></div>
      <br>
      <div class="summary-row"><b>Your Profit:</b> <span>$${yourProfit.toFixed(2)}</span></div>
      <div class="summary-row"><b>Total Pieces:</b> <span>${totalPieces}</span></div>
    `;
  }

  function clearCart() {
    cart = {};
    renderCart();
  }

  // ---- PRESET PLATTERS ----
  function buildPlatter(type) {
    if (!menuItems.length) return;

    const rolls = menuItems.filter(i => i.name.toLowerCase().includes("roll"));
    const nigiri = menuItems.filter(i => i.name.toLowerCase().includes("nigiri"));
    const vegRolls = rolls.filter(i => i.tags.veg);

    if (type === "veg") {
      vegRolls.slice(0, 4).forEach(it => {
        const name = it.name;
        if (!cart[name]) cart[name] = { item: it, qty: 0 };
        cart[name].qty += 2;
      });
    } else if (type === "mixed") {
      rolls.slice(0, 3).forEach(it => {
        const name = it.name;
        if (!cart[name]) cart[name] = { item: it, qty: 0 };
        cart[name].qty += 2;
      });
      nigiri.slice(0, 5).forEach(it => {
        const name = it.name;
        if (!cart[name]) cart[name] = { item: it, qty: 0 };
        cart[name].qty += 4;
      });
    } else if (type === "nigiri") {
      nigiri.slice(0, 8).forEach(it => {
        const name = it.name;
        if (!cart[name]) cart[name] = { item: it, qty: 0 };
        cart[name].qty += 5;
      });
    }

    renderCart();
  }

  // ---- PRICE EDIT ----
  function initEditSelect() {
    const sel = document.getElementById("editItemSelect");
    sel.innerHTML = "";
    menuItems.forEach(it => {
      const opt = document.createElement("option");
      opt.value = it.name;
      opt.textContent = `${it.name} ($${it.price.toFixed(2)})`;
      sel.appendChild(opt);
    });
  }

  function updateItemPrice() {
    const sel = document.getElementById("editItemSelect");
    const name = sel.value;
    const newPrice = parseFloat(document.getElementById("editPriceInput").value || "NaN");
    if (isNaN(newPrice) || newPrice < 0) {
      alert("Enter a valid price.");
      return;
    }
    const item = menuItems.find(i => i.name === name);
    if (!item) return;
    item.price = newPrice;
    if (cart[name]) cart[name].item.price = newPrice;
    initEditSelect();
    renderMenu();
    renderCart();
  }

  // ---- DARK MODE ----
  function toggleDarkMode() {
    document.body.classList.toggle("dark");
  }
</script>

</body>
</html>
