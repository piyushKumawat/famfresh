<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sushi Platter Builder</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  :root {
    --bg: #f5f5f7;
    --card: #ffffff;
    --text: #222;
    --muted: #666;
    --accent: #ff7043;
    --accent2: #1976d2;
    --danger: #c62828;
    --shadow: 0 2px 10px rgba(0,0,0,0.08);
  }
  body.dark {
    --bg: #101018;
    --card: #1d1f27;
    --text: #f5f5f5;
    --muted: #9fa3b5;
    --accent: #ffa726;
    --accent2: #64b5f6;
    --danger: #ef5350;
    --shadow: 0 2px 18px rgba(0,0,0,0.7);
  }

  * { box-sizing: border-box; }

  body {
    margin: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: var(--bg);
    color: var(--text);
  }

  header {
    background: #000;
    color: #fff;
    padding: 10px 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  header h1 {
    margin: 0;
    font-size: 18px;
  }

  .btn {
    background: var(--accent);
    border: none;
    padding: 7px 14px;
    border-radius: 999px;
    color: #fff;
    font-size: 13px;
    cursor: pointer;
  }

  .btn.small {
    padding: 5px 10px;
    font-size: 12px;
  }

  .main {
    display: flex;
    gap: 12px;
    padding: 12px;
  }

  .panel {
    background: var(--card);
    padding: 12px;
    border-radius: 12px;
    box-shadow: var(--shadow);
  }

  /* Desktop layout: menu 77%, cart 23% */
  .left-panel {
    flex: 0 0 77%;
    max-width: 77%;
  }

  .right-panel {
    flex: 0 0 23%;
    max-width: 23%;
  }

  @media (max-width: 900px) {
    .main {
      flex-direction: column;
    }
    .left-panel,
    .right-panel {
      flex: 1 1 100%;
      max-width: 100%;
    }
  }

  h2, h3 {
    margin-top: 0;
  }

  input[type="text"],
  input[type="number"] {
    width: 100%;
    padding: 7px 9px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 14px;
    margin-bottom: 8px;
    background: transparent;
    color: var(--text);
  }

  .filters {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 10px;
  }

  .chip {
    padding: 4px 10px;
    border-radius: 999px;
    border: 1px solid #aaa;
    font-size: 12px;
    cursor: pointer;
    background: #f3f3f3;
    color: #333;
  }

  body.dark .chip {
    background: #333;
    color: #eee;
    border-color: #555;
  }

  .chip.active {
    background: var(--accent2);
    color: #fff;
    border-color: var(--accent2);
  }

  .menu-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
    gap: 10px;
  }

  .card {
    background: var(--card);
    border-radius: 12px;
    padding: 10px;
    box-shadow: var(--shadow);
  }

  .card img {
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 10px;
    background: #ddd;
  }

  .card-title {
    font-size: 15px;
    font-weight: 600;
    margin-top: 8px;
  }

  .meta {
    font-size: 12px;
    color: var(--muted);
    margin: 2px 0;
  }

  .qty-row {
    display: flex;
    gap: 6px;
    align-items: center;
    margin-top: 8px;
  }

  .qty-row input {
    width: 60px;
    text-align: center;
  }

  .cart-item {
    border-bottom: 1px solid #ddd;
    padding: 8px 0;
  }

  body.dark .cart-item {
    border-color: #444;
  }

  .cart-line-top {
    display: flex;
    justify-content: space-between;
    font-size: 14px;
  }

  .cart-line-bottom {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: var(--muted);
    margin-top: 2px;
    align-items: center;
  }

  .qty-btn {
    background: var(--accent2);
    border: none;
    border-radius: 4px;
    width: 24px;
    height: 24px;
    color: #fff;
    font-size: 16px;
    cursor: pointer;
  }

  .remove-btn {
    background: var(--danger);
    border: none;
    border-radius: 4px;
    padding: 3px 6px;
    font-size: 11px;
    color: #fff;
    cursor: pointer;
    margin-left: 6px;
  }

  .summary-row {
    display: flex;
    justify-content: space-between;
    font-size: 13px;
    margin: 2px 0;
  }

  .muted {
    font-size: 11px;
    color: var(--muted);
  }
</style>
</head>

<body>

<header>
  <h1>Sushi Platter Builder</h1>
  <button class="btn small" onclick="toggleDarkMode()">Dark Mode</button>
</header>

<div class="main">

  <!-- LEFT: MENU -->
  <div class="panel left-panel">
    <h2>Menu</h2>

    <input id="searchInput" type="text" placeholder="Search by name, filling, sauces..." oninput="renderMenu()">

    <div class="filters">
      <span class="chip" data-filter="all" onclick="toggleFilter('all')">All</span>
      <span class="chip" data-filter="roll" onclick="toggleFilter('roll')">Rolls</span>
      <span class="chip" data-filter="nigiri" onclick="toggleFilter('nigiri')">Nigiri</span>
      <span class="chip" data-filter="veg" onclick="toggleFilter('veg')">Veg</span>
      <span class="chip" data-filter="spicy" onclick="toggleFilter('spicy')">Spicy</span>
      <span class="chip" data-filter="raw" onclick="toggleFilter('raw')">Raw</span>
      <span class="chip" data-filter="cooked" onclick="toggleFilter('cooked')">Cooked</span>
    </div>

    <div id="menuGrid" class="menu-grid"></div>
  </div>

  <!-- RIGHT: CART -->
  <div class="panel right-panel">
    <h2>Cart</h2>
    <div id="cartContainer"></div>

    <h3 style="margin-top:12px;">Tax %</h3>
    <input id="taxInput" type="number" value="8" step="0.1" onchange="renderCart()">

    <h3 style="margin-top:12px;">Totals</h3>
    <div id="summaryBox"></div>

    <button class="btn" style="margin-top:10px; width:100%;" onclick="clearCart()">Clear Cart</button>
  </div>

</div>

<script>
const SHEET_URL =
  "https://opensheet.elk.sh/1zf6BTACk1tLWS9diRqQ3m93aQawfHftiELjByrWjBgE/Sheet1";

let menuItems = [];
let cart = {};
let filters = {
  all: true,
  roll: false,
  nigiri: false,
  veg: false,
  spicy: false,
  raw: false,
  cooked: false
};

// Universal column getter (handles spaces/case, e.g. "Filling  ")
function col(row, name) {
  const target = name.trim().toLowerCase();
  for (const key in row) {
    if (key.trim().toLowerCase() === target) {
      return row[key] || "";
    }
  }
  return "";
}

// Load Google Sheet
fetch(SHEET_URL)
  .then(res => res.json())
  .then(data => {
    menuItems = data
      .map(row => {
        const image = col(row, "Sushi Plating").trim();  // image URL
        const name  = col(row, "Name").trim();

        // Price: clean "$9.49" ‚Üí 9.49
        const rawPrice = col(row, "Price");
        const price = parseFloat(rawPrice.toString().replace(/[$,]/g, "")) || 0;

        const filling = col(row, "Filling");   // works even if "Filling  "
        const sauces  = col(row, "Sauces");
        const toppings= col(row, "Toppings");

        const saucesToppings = [sauces, toppings]
          .filter(v => v && v.toString().trim() !== "")
          .join(", ");

        if (!name) return null;

        const tags = deriveTags(name, filling, saucesToppings);

        return { image, name, price, filling, saucesToppings, tags };
      })
      .filter(Boolean);

    updateFilterChips();
    renderMenu();
  })
  .catch(err => {
    console.error("Sheet load error:", err);
    document.getElementById("menuGrid").innerHTML =
      "<p>Could not load menu. Check publish settings.</p>";
  });

// Tagging (Roll/Nigiri/Veg/Spicy/Raw/Cooked)
function deriveTags(name, fill, sauces) {
  const t = (name + " " + fill + " " + sauces).toLowerCase();
  return {
    roll:   t.includes("roll"),
    nigiri: t.includes("nigiri"),
    veg:    ["cucumber","avocado","vegetable","asparagus","tofu"].some(w => t.includes(w)),
    spicy:  t.includes("spicy") || t.includes("jalapeno") || t.includes("chili"),
    raw:    t.includes("raw") || t.includes("sashimi"),
    cooked: ["tempura","fried","baked","grilled","eel","shrimp"].some(w => t.includes(w))
  };
}

// Filters
function toggleFilter(key) {
  if (key === "all") {
    filters = { all:true, roll:false, nigiri:false, veg:false, spicy:false, raw:false, cooked:false };
  } else {
    filters.all = false;
    filters[key] = !filters[key];
    // if no filters other than "all" are active, reset to all
    if (!Object.keys(filters).some(k => k !== "all" && filters[k])) {
      filters.all = true;
    }
  }
  updateFilterChips();
  renderMenu();
}

function updateFilterChips() {
  document.querySelectorAll(".chip").forEach(chip => {
    const f = chip.getAttribute("data-filter");
    chip.classList.toggle("active", !!filters[f]);
  });
}

function passesFilters(item) {
  if (filters.all) return true;
  if (filters.roll   && !item.tags.roll)   return false;
  if (filters.nigiri && !item.tags.nigiri) return false;
  if (filters.veg    && !item.tags.veg)    return false;
  if (filters.spicy  && !item.tags.spicy)  return false;
  if (filters.raw    && !item.tags.raw)    return false;
  if (filters.cooked && !item.tags.cooked) return false;
  return true;
}

// Render menu cards
function renderMenu() {
  const grid = document.getElementById("menuGrid");
  const search = (document.getElementById("searchInput").value || "").toLowerCase();

  grid.innerHTML = "";

  menuItems
    .filter(it => passesFilters(it))
    .filter(it => {
      if (!search) return true;
      const s = (it.name + " " + it.filling + " " + it.saucesToppings).toLowerCase();
      return s.includes(search);
    })
    .forEach(it => {
      const icons = [
        it.tags.veg ? "ü•ó" : "",
        it.tags.spicy ? "üå∂Ô∏è" : "",
        it.tags.raw ? "üêü" : "",
        it.tags.cooked ? "üç§" : ""
      ].filter(Boolean).join(" ");

      const imgSrc = it.image || "https://via.placeholder.com/400x300?text=Sushi";

      grid.innerHTML += `
        <div class="card">
          <img src="${imgSrc}" alt="${it.name}"
               onerror="this.src='https://via.placeholder.com/400x300?text=Sushi';">
          <div class="card-title">${it.name} ‚Äî $${it.price.toFixed(2)}</div>
          <div class="meta">${icons}</div>
          <div class="meta"><b>Filling:</b> ${it.filling || "‚Äî"}</div>
          <div class="meta"><b>Sauces + Toppings:</b> ${it.saucesToppings || "‚Äî"}</div>
          <div class="qty-row">
            <input type="number" id="qty-${slug(it.name)}" value="1" min="1">
            <button class="btn small" onclick="addToCart('${encodeURIComponent(it.name)}')">Add</button>
          </div>
        </div>
      `;
    });

  if (!grid.innerHTML) {
    grid.innerHTML = "<p class='muted'>No items match your filters/search.</p>";
  }
}

function slug(name) {
  return name.replace(/\s+/g, "_").replace(/[^a-zA-Z0-9_]/g, "");
}

// Cart logic
function addToCart(encodedName) {
  const name = decodeURIComponent(encodedName);
  const item = menuItems.find(i => i.name === name);
  if (!item) return;

  const qtyInput = document.getElementById("qty-" + slug(name));
  let qty = parseInt(qtyInput?.value || "1");
  if (isNaN(qty) || qty < 1) qty = 1;

  if (!cart[name]) {
    cart[name] = { item, qty: 0 };
  }
  cart[name].qty += qty;

  renderCart();
}

function changeQty(name, delta) {
  if (!cart[name]) return;
  cart[name].qty += delta;
  if (cart[name].qty <= 0) delete cart[name];
  renderCart();
}

function removeFromCart(name) {
  delete cart[name];
  renderCart();
}

// 10 pcs per roll, 1 per nigiri (by name)
function pieces(item) {
  return item.name.toLowerCase().includes("nigiri") ? 1 : 10;
}

function renderCart() {
  const cartDiv = document.getElementById("cartContainer");
  const summaryDiv = document.getElementById("summaryBox");

  cartDiv.innerHTML = "";

  let subtotal = 0;
  let totalPieces = 0;

  Object.keys(cart).forEach(name => {
    const { item, qty } = cart[name];
    const lineTotal = item.price * qty;
    const pcs = pieces(item) * qty;

    subtotal += lineTotal;
    totalPieces += pcs;

    cartDiv.innerHTML += `
      <div class="cart-item">
        <div class="cart-line-top">
          <span><b>${name}</b></span>
          <span>$${lineTotal.toFixed(2)}</span>
        </div>
        <div class="cart-line-bottom">
          <span>
            <button class="qty-btn" onclick="changeQty('${name.replace(/'/g,"\\'")}', -1)">-</button>
            ${qty}
            <button class="qty-btn" onclick="changeQty('${name.replace(/'/g,"\\'")}', 1)">+</button>
            <button class="remove-btn" onclick="removeFromCart('${name.replace(/'/g,"\\'")}')">x</button>
          </span>
          <span>${pcs} pcs</span>
        </div>
      </div>
    `;
  });

  if (!Object.keys(cart).length) {
    cartDiv.innerHTML = "<p class='muted'>Cart is empty.</p>";
  }

  const taxRate = parseFloat(document.getElementById("taxInput").value || "0") / 100;
  const tax = subtotal * taxRate;
  const total = subtotal + tax;

  summaryDiv.innerHTML = `
    <div class="summary-row"><span><b>Subtotal:</b></span><span>$${subtotal.toFixed(2)}</span></div>
    <div class="summary-row"><span><b>Tax:</b></span><span>$${tax.toFixed(2)}</span></div>
    <div class="summary-row"><span><b>Total:</b></span><span>$${total.toFixed(2)}</span></div>
    <br>
    <div class="summary-row"><span><b>Total Pieces:</b></span><span>${totalPieces}</span></div>
  `;
}

function clearCart() {
  cart = {};
  renderCart();
}

// Dark mode
function toggleDarkMode() {
  document.body.classList.toggle("dark");
}
</script>

</body>
</html>
